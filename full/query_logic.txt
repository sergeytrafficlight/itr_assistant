op_analyze_kpi_query = {}

op_analyze_kpi_query.exclude_category = function() {
  return ['Архив', 'Входящая линия']
}

op_analyze_kpi_query.get_kpi_query = function () {
  var q = "SELECT\n"+
  "offer_plan.id as call_eff_kpi_id,\n"+
  "offer_plan.period_date as call_eff_period_date,\n"+
  "offer_plan.offer_id as call_eff_offer_id,\n"+
  "aff.external_id as call_eff_affiliate_id,\n"+
  "offer_plan.operator_efficiency as call_eff_operator_efficiency\n"+
  "FROM partners_tlofferplanneddataperiod AS offer_plan\n"+
  "LEFT JOIN partners_affiliate aff ON aff.id = offer_plan.affiliate_id\n"+
  "ORDER BY period_date ASC";
  return q;
}

op_analyze_kpi_query.get_offers = function (v) {
  var offer_a = prepare_sql_array(v.offer_id)
  var category_a = prepare_sql_array(v.category)
  var excl_category = prepare_sql_array_array(op_analyze_kpi_query.exclude_category())
  var q = "SELECT\n"+
  "partners_offer.id as id,\n"+
  "partners_offer.name as name,\n"+
  "group_offer.name as category_name\n"+
  "FROM partners_offer\n"+
  "LEFT JOIN partners_assignedoffer assigned_offer ON assigned_offer.offer_id = partners_offer.id \n"+ 
  "LEFT JOIN partners_groupoffer group_offer ON assigned_offer.group_id = group_offer.id \n"+
  "WHERE 1=1\n";
  q += "AND group_offer.name NOT IN (" + excl_category + ")\n";

  if (category_a.length)
    q += "AND group_offer.name IN (" + category_a + ")";
  if (offer_a.length)
    q += "AND partners_offer.id IN (" + offer_a + ")\n";
  return q;
}

op_analyze_kpi_query.get_lead = function (v) {

  var date_from = normalize_datetime(v.date_from, "00:00:00");
  var date_to = normalize_datetime(v.date_to, "23:59:59");
  var advertiser = prepare_sql_array(v.advertiser)
  var offer_a = prepare_sql_array(v.offer_id)
  var category_a = prepare_sql_array(v.category);
  var excl_category = prepare_sql_array_array(op_analyze_kpi_query.exclude_category())
  var lv_op_a = prepare_sql_array(v.lv_op);
  var aff_id_a = prepare_sql_array(v.aff_id)

  var q = ""+
  "SELECT\n"+
  "crm_leads_crmlead.id call_eff_crm_lead_id,\n"+
  "LEFT(DATE_ADD(lv.approved_at, INTERVAL 3 HOUR), 19) AS call_eff_approved_at,\n"+
  "LEFT(DATE_ADD(lv.canceled_at, INTERVAL 3 HOUR), 19) AS call_eff_canceled_at,\n"+
  "lv_op.username as lv_username,\n"+  
  "uu.id as call_eff_operator_id,\n"+
  "lv_status.status_verbose as call_eff_status_verbose,\n"+
  "lv_status.status_group as call_eff_status_group,\n"+
  //-----------
  "offer.id as offer_id,\n"+
  "offer.name as offer_name,\n"+
  "group_offer.name as category_name,\n"+  
  "tl_lead.webmaster_id as aff_id\n"+
  "FROM partners_lvlead lv\n"+
  "LEFT JOIN crm_leads_crmlead ON crm_leads_crmlead.lvlead_id = lv.id\n"+
  "LEFT JOIN partners_lvoperator lv_op ON lv_op.id = lv.operator_id\n"+
  "LEFT JOIN partners_userbasedonlvoperator pu ON pu.operator_id = lv.operator_id \n"+
  "LEFT JOIN users_user uu ON uu.id = pu.user_id \n"+
  "LEFT JOIN partners_lvleadstatuses AS lv_status ON lv.leadvertex_status_id = lv_status.id \n"+  
  "LEFT JOIN partners_tllead AS tl_lead ON lv.tl_id = tl_lead.external_id\n"+  
  "LEFT JOIN partners_subsystem AS subsystem ON subsystem.id = tl_lead.subsystem_id\n"+  
  "LEFT JOIN partners_offer as offer ON tl_lead.offer_id = offer.id\n"+  
  "LEFT JOIN partners_assignedoffer assigned_offer ON assigned_offer.offer_id = offer.id \n"+ 
  "LEFT JOIN partners_groupoffer group_offer ON assigned_offer.group_id = group_offer.id \n"+

  "WHERE 1=1\n";

  q += "AND offer.id IS NOT NULL\n";
  q += "AND lv_op.username IS NOT NULL\n"
  q += "AND group_offer.name NOT IN (" + excl_category + ")\n";

  if (category_a.length)
    q += "AND group_offer.name IN (" + category_a + ")";
  if (date_from.length)
    q += "AND DATE_ADD(lv.approved_at, INTERVAL 3 HOUR) >= '" + date_from + "'\n";
  if (date_to.length)
    q += "AND DATE_ADD(lv.approved_at, INTERVAL 3 HOUR) < '" + date_to + "'\n";
  if (offer_a.length)
    q += "AND offer.id IN (" + offer_a + ")\n"; 
  if (advertiser.length)
    q += "AND LOWER(subsystem.name) IN (" + advertiser + ")\n";  
  if (lv_op_a.length)
    q += "AND LOWER(lv_op.username) IN (" + lv_op_a + ")\n"; 
  if (aff_id_a.length)
    q += "AND tl_lead.webmaster_id IN (" + aff_id_a + ")\n";

  return q;

}

op_analyze_kpi_query.get_call = function(v) {
  var date_from = normalize_datetime(v.date_from, "00:00:00");
  var date_to = normalize_datetime(v.date_to, "23:59:59");
  var advertiser = prepare_sql_array(v.advertiser)
  var offer_a = prepare_sql_array(v.offer_id)
  var category_a = prepare_sql_array(v.category);
  var excl_category = prepare_sql_array_array(op_analyze_kpi_query.exclude_category())  
  var lv_op_a = prepare_sql_array(v.lv_op);
  var aff_id_a = prepare_sql_array(v.aff_id)

  var q = ""+
    "SELECT\n"+
    "partners_atscallevent.id as call_eff_id,\n"+    
    "crm_call_calldata.id as call_eff_crm_id,\n"+ 
    "po.id as call_eff_offer_id,\n"+  
    "po.name as offer_name,\n" +   
    "partners_atscallevent.uniqueid as call_eff_uniqueid,\n"+
    "LEFT(DATE_ADD(partners_atscallevent.calldate, INTERVAL 3 HOUR), 10) AS call_eff_calldate,\n"+
    "crm_call_calldata.crm_lead_id as call_eff_crm_lead_id,\n"+    
    "uu.id as call_eff_operator_id,\n"+
    "partners_atscallevent.billsec as call_eff_billsec,\n"+
    "crm_call_calldata.oktell_duration as call_eff_billsec_exact,\n"+
    "crm_call_calldata.oktell_anti_robot as call_eff_robo_detected,\n"+
    "lv_op.username as lv_username,\n"+
    "group_offer.name as category_name,\n"+    
    "pt.webmaster_id as call_eff_affiliate_id\n"+
    "FROM partners_atscallevent\n"+
    "LEFT JOIN crm_call_calldata ON crm_call_calldata.id = partners_atscallevent.assigned_call_data_id\n"+
    "LEFT JOIN partners_lvlead ON partners_atscallevent.lvlead_id = partners_lvlead.id\n"+
    "LEFT JOIN crm_leads_crmlead ON crm_leads_crmlead.lvlead_id = partners_lvlead.id\n"+    
    "LEFT JOIN partners_lvoperator lv_op ON lv_op.id = partners_atscallevent.lvoperator_id\n"+
    "LEFT JOIN partners_userbasedonlvoperator pu ON pu.operator_id = partners_atscallevent.lvoperator_id\n"+
    "LEFT JOIN users_user uu ON uu.id = pu.user_id\n"+
    "LEFT JOIN users_department ud ON ud.id = uu.department_id\n"+    
    "LEFT JOIN partners_tllead pt ON partners_lvlead.tl_id = pt.external_id \n " +         
    "LEFT JOIN partners_subsystem AS subsystem ON subsystem.id = pt.subsystem_id\n"+      
    "LEFT JOIN partners_offer po ON pt.offer_id = po.id \n " +
    "LEFT JOIN partners_assignedoffer assigned_offer ON assigned_offer.offer_id = po.id \n"+ 
    "LEFT JOIN partners_groupoffer group_offer ON assigned_offer.group_id = group_offer.id \n"+
    "LEFT JOIN crm_call_oktelltask ON partners_atscallevent.oktell_task_id = crm_call_oktelltask.id\n"+            
    "WHERE 1=1\n"+
    "AND partners_atscallevent.billsec >= 30\n"+
    "AND ((ud.name LIKE N'%_НП_%' or ud.name LIKE N'%_СП_%') or (crm_call_oktelltask.type = 'new_sales'))\n" +
    "AND po.id IS NOT null\n";
    q += "AND lv_op.username IS NOT NULL\n"
    q += "AND group_offer.name NOT IN (" + excl_category + ")\n";

    if (category_a.length)
      q += "AND group_offer.name IN (" + category_a + ")";
    if (date_from)
      q += "AND DATE_ADD(partners_atscallevent.calldate, INTERVAL 3 HOUR) >= '" + date_from + "'\n";
    if (date_to)
      q += "AND DATE_ADD(partners_atscallevent.calldate, INTERVAL 3 HOUR) < '" + date_to + "'\n";
    if (v.offer_id.length)
      q += "AND po.id IN (" + offer_a + ")\n"; 
    if (advertiser.length)
      q += "AND LOWER(subsystem.name) IN (" + advertiser + ")\n";   
    if (lv_op_a.length)
      q += "AND LOWER(lv_op.username) IN (" + lv_op_a + ")\n"; 
    if (aff_id_a.length)
      q += "AND pt.webmaster_id IN (" + aff_id_a + ")\n";      

    return q;
}

op_analyze_kpi_query.get_leads_container = function(v) {

  var date_from = normalize_datetime(v.date_from, "00:00:00");
  var date_to = normalize_datetime(v.date_to, "23:59:59");
  var advertiser = prepare_sql_array(v.advertiser)
  var offer_a = prepare_sql_array(v.offer_id)
  var category_a = prepare_sql_array(v.category);
  var excl_category = prepare_sql_array_array(op_analyze_kpi_query.exclude_category())  
  var lv_op_a = prepare_sql_array(v.lv_op);
  var aff_id_a = prepare_sql_array(v.aff_id)


  var q = "SELECT\n"+
    "crm_leads_crmlead.id lead_container_crm_lead_id,\n"+
    "crm_leads_crmlead.id call_eff_crm_lead_id,\n"+    
    "LEFT(DATE_ADD(lv.created_at, INTERVAL 3 HOUR), 19) lead_container_created_at,\n"+    
    "LEFT(DATE_ADD(lv.approved_at, INTERVAL 3 HOUR), 19) lead_container_approved_at,\n"+
    "LEFT(DATE_ADD(lv.canceled_at, INTERVAL 3 HOUR), 19) lead_container_canceled_at,\n"+    
    "LEFT(DATE_ADD(lv.buyout_at, INTERVAL 3 HOUR), 19) lead_container_buyout_at,\n"+
    "lv_status.status_verbose as lead_container_status_verbose,\n"+
    "lv_status.status_group as lead_container_status_group,\n"+    
    "pt.is_trash as lead_container_is_trash,\n" +
    "LEFT(DATE_ADD(lv.created_at, INTERVAL 3+24 HOUR), 19) lead_container_lead_ttl_till,\n"+
    "LEFT(DATE_ADD(NOW(), INTERVAL 3 HOUR), 19) as lead_container_now,\n" +
    "offer.id as offer_id,\n" + 
    "offer.name as offer_name,\n" + 
    "pt.webmaster_id as aff_id,\n" + 
    "null as lv_username,\n"+ 
    "group_offer.name as category_name\n"+
    "FROM partners_lvlead lv\n"+
    "LEFT JOIN crm_leads_crmlead ON crm_leads_crmlead.lvlead_id = lv.id\n"+
    "LEFT JOIN partners_tllead pt ON lv.tl_id = pt.external_id\n"+
    "LEFT JOIN partners_lvleadstatuses AS lv_status ON lv.leadvertex_status_id = lv_status.id\n"+
    "LEFT JOIN partners_offer as offer ON pt.offer_id = offer.id\n"+  
    "LEFT JOIN partners_assignedoffer assigned_offer ON assigned_offer.offer_id = offer.id \n"+ 
    "LEFT JOIN partners_groupoffer group_offer ON assigned_offer.group_id = group_offer.id \n"+
    "LEFT JOIN partners_subsystem AS subsystem ON subsystem.id = pt.subsystem_id\n"+      

    "WHERE 1=1\n";

    q += "AND offer.id IS NOT NULL\n";
    
    q += "AND group_offer.name NOT IN (" + excl_category + ")\n";

    if (category_a.length)
      q += "AND group_offer.name IN (" + category_a + ")";
    if (date_from.length)
      q += "AND DATE_ADD(lv.created_at, INTERVAL 3 HOUR) >= '" + date_from + "'\n";
    if (date_to.length)
      q += "AND DATE_ADD(lv.created_at, INTERVAL 3 HOUR) < '" + date_to + "'\n";
    if (offer_a.length)
      q += "AND offer.id IN (" + offer_a + ")\n"; 
    if (advertiser.length)
      q += "AND LOWER(subsystem.name) IN (" + advertiser + ")\n";  
    if (aff_id_a.length)
      q += "AND pt.webmaster_id IN (" + aff_id_a + ")\n";    

    return q;
}
