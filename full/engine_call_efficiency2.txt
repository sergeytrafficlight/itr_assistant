
engine_call_effeciency2 = {}

engine_call_effeciency2.min_eff = 0.1

engine_call_effeciency2.kpi = function(r) {
  this.id = r.getInt('call_eff_kpi_id');
  this.update_date = r.getString('call_eff_plan_update_date');
  this.period_date = r.getString("call_eff_period_date");
  this.offer_id = r.getString('call_eff_offer_id');
  this.affiliate_id = r.getString('call_eff_affiliate_id');

  this.confirmation_price = r.getFloat('call_eff_confirmation_price');
  this.buyout_price = r.getFloat('call_eff_buyout_price')

  this.operator_efficiency = r.getFloat('call_eff_operator_efficiency');
  this.operator_effeciency_update_date = r.getString('call_eff_operator_efficiency_update_date');

  this.planned_approve = r.getFloat('call_eff_planned_approve');
  this.planned_approve_update_date = r.getString('call_eff_approve_update_date');

  this.planned_buyout = r.getFloat('call_eff_planned_buyout');
  this.planned_buyout_update_date = r.getString('call_eff_buyout_update_date');

  this.confirmation_price = r.getFloat('call_eff_confirmation_price');
  this.confirmation_price_update_date = r.getString('call_eff_confirmation_price_update_date');

  this.buyout_price = r.getFloat('call_eff_buyout_price');
  this.buyout_price_update_date = r.getString('call_eff_buyout_price_update_date');


  this.key_aff_offer = engine_call_effeciency2.kpi_make_key(this.affiliate_id, this.offer_id);

  if (this.affiliate_id == null)
    this.is_personal_plan = false;
  else
    this.is_personal_plan = true;
  
  this.print = function() {
    return "ID: " + this.id + 
      " date: " + this.period_date + 
      " offer_id: " + this.offer_id + 
      " affiliate_id: " + this.affiliate_id +
      " op_eff: " + this.operator_efficiency;
  }

  if (this.period_date.length != 10)
    throw "Wrong date for KPI '" + this.period_date + "' len(" + this.period_date.length + ") (" + this.print_kpi() + ")";
}

engine_call_effeciency2.kpi_make_key = function(affiliate_id, offer_id) {
  if (affiliate_id == null) return offer_id;
  return affiliate_id + "-" + offer_id;
}

engine_call_effeciency2.kpi_make_key_cache = function(affiliate_id, offer_id, date) {
  return affiliate_id + "-" + offer_id + "-" + date;
}

engine_call_effeciency2.call = function(r) {
  this.id = r.getInt('call_eff_id')
  this.crm_id = r.getInt('call_eff_crm_id')
  this.offer_id = r.getInt('call_eff_offer_id');
  this.uniqueid = r.getString('call_eff_uniqueid');
  this.billsec = r.getInt('call_eff_billsec')
  // в случае работы через авто-дозвон, уточненное время включения оператора (сколько времени оператор реально провел в лини), т.к. оп. может быть включен в линию позже начала Разговора
  

  this.billsec_exact  = r.getString('call_eff_billsec_exact');
  if (this.billsec_exact != null) {
    //Logger.log("Before parse: " + this.billsec_exact)
    this.billsec_exact = parseInt(this.billsec_exact);
    // Logger.log("After parse: " + this.billsec_exact);
  }

  if (this.billsec_exact < 0)
    this.billsec_exact = this.billsec

  /* 
  // ответил автоотвечтик
  this.robo_detected  = r.getInt('call_eff_robo_detected');
*/

  this.operator_id = r.getInt('call_eff_operator_id');
  this.crm_lead_id = r.getInt('call_eff_crm_lead_id')
  this.calldate_str = r.getString('call_eff_calldate');
  this.affiliate_id = r.getString('call_eff_affiliate_id');

  // this.is_anti_robot = r.getString('')

  if (this.billsec == null)
    throw "Billsec is null id: " + this.id

  engine.assert(this.billsec_exact == null || this.billsec_exact >= 0, "Unexpected billsec exact: " + this.billsec_exact + " unique id: " + this.uniqueid);

  if (this.billsec_exact != null && this.billsec_exact < this.billsec)
    this.billsec = this.billsec_exact;

  this.calldate_date_str = this.calldate_str.substring(0, 10);

//  if (this.offer_id == 0)
//    throw "Can't find offer id for call crm id: " + this.crm_id

  this.make_key = function() {
    return this.calldate_date_str + " " + this.operator_id + " " + this.crm_lead_id;
  }

  this.print = function() {
    return "ID: " + this.id + 
      " crm id: " + this.crm_id +
      " offer_id: " + this.offer_id + 
      " affiliate_id: " + this.affiliate_id +
      " calldate: " + this.calldate_str;
  }

}

engine_call_effeciency2.lead = function(r) {
  this.crm_lead_id = r.getInt('call_eff_crm_lead_id');
  this.approved_at = trim_if_null(r.getString("call_eff_approved_at"));
  this.canceled_at = trim_if_null(r.getString('call_eff_canceled_at'));
  this.status_verbose = r.getString('call_eff_status_verbose');
  this.status_group = r.getString('call_eff_status_group');
  this.operator_id = r.getInt('call_eff_operator_id')

  this.is_salary_pay = true;
  this.is_salay_not_pay_reason = "";

  if (this.offer_id == 0)
    throw "Can't find offer id for lead crm id: " + this.crm_lead_id

  this.set_no_salary = function(reason) {
    this.is_salary_pay = false;
    this.is_salary_not_pay_reason = reason;
  }

  this.finalyze = function() {

    this.is_salay_not_pay_reason = engine_leads_processing.is_fake_approve(this);
    this.is_salary_pay =  (this.is_salay_not_pay_reason == "")
/*
    this.status_verbose = this.status_verbose.toLowerCase();

    if (this.approved_at == '' || this.approved_at == null)
      return this.set_no_salary('заказ не подтвержден')
    if ((this.operator_id == null || this.operator_id == ''))
      return this.set_no_salary('оператор не найден')        
    if (this.status_verbose.indexOf('отправить позже') > -1)
      return this.set_no_salary("Заказ в статусе 'Отправить позже'")
    if (this.approved_at <= this.canceled_at && (this.canceled_at != '' || this.canceled_at == null))
      return this.set_no_salary("Заказ отменён (" + this.canceled_at + ") после подтверждения ("+this.approved_at+")");
    if (this.status_verbose.indexOf('отмен') > -1)      
      return this.set_no_salary('Заказ отменен');
    if (this.status_verbose.indexOf('предоплаты') > -1)
      return this.set_no_salary('Заказ в статусе предоплаты');
    if (this.status_verbose.indexOf('4 день') > -1)
      return this.set_no_salary("Заказ в статусе '4 день '")
    if (this.status_verbose.indexOf('3 день') > -1)
      return this.set_no_salary("Заказ в статусе '3 день '")
    if (this.status_verbose.indexOf('2 день') > -1)
      return this.set_no_salary("Заказ в статусе '2 день'")
    if (this.status_verbose.indexOf('1 день') > -1)
      return this.set_no_salary("Заказ в статусе '1 день '")      
*/
  }
}

engine_call_effeciency2.call_group = function(key, c, effeciency_call_seconds) {

  this.key = key;
  this.calls = {}
  this.calls_effective = {}
  this.call_effective_frist = null;
  this.is_effective = false;
  this.calls_effective_count = 0;
  this.offer_id = c.offer_id;
  this.affiliate_id = c.affiliate_id;
  this.calldate_str = c.calldate_str;
  this.effeciency_call_seconds = effeciency_call_seconds;

  this.push_call = function(call) {

    if (call.uniqueid in this.calls) {
      this.calls[call.uniqueid].billsec = Math.max(this.calls[call.uniqueid].billsec, call.billsec)
    } else {    
      this.calls[call.uniqueid] = call;
    }
  }

  this.finalyze = function() {
    for (var i in this.calls) {
      if (this.calls[i].billsec >= this.effeciency_call_seconds) {
        //Logger.log("PUSH CALL id: " + call.id + " uniq: " + call.uniqueid + " lead id: " + call.crm_lead_id)
        this.calls_effective[this.calls[i].uniqueid] = this.calls[i];
        this.calls_effective_count++;
        if (this.call_effective_first == null)
          this.call_effective_first = this.calls[i];
      }      
    }
    if (this.calls_effective_count)
      this.is_effective = true;
  }

}

engine_call_effeciency2.kpi_list = function() {

  this.kpi_by_aff_offer = {}
  this.kpi_by_offer = {}

  this.kpi_cache = {}

  this.push_kpi_item = function(l, kpi, key) {
    if (!(key in l))
      l[key] = [];
    var e = l[key];

    if (e.length) {
      if (e[e.length-1].period_date > kpi.period_date)
        throw "Wrong kpi sort order\n" +
          "prev: " + e[e.length-1].print() + "\n" +
          "new: " + kpi.print() + "\n";
    }
    e.push(kpi);    
  }

  this.push_kpi = function(sql) {
    var k = new engine_call_effeciency2.kpi(sql);
    if (k.affiliate_id != null) {
      this.push_kpi_item(this.kpi_by_aff_offer, k, k.key_aff_offer);
    } else {
      this.push_kpi_item(this.kpi_by_offer, k, k.offer_id);
    }
  }

  this.find_kpi_by_list = function(l, key, period_date) {

    if (!(key in l))
      return null;

    var p = l[key];
    for (var i = p.length - 1; i >= 0; i--) {
      if (p[i].period_date > period_date)
        continue;
      return p[i];
    }

    return null;    
  }

  this.find_kpi = function(affiliate_id, offer_id, period_date) {

    if (period_date.length != 10)
      throw "Wrong kpi request period date '" + period_date + "' expecting len 10";

    var r = null;

    if (affiliate_id != null) {      
      var key_cache = engine_call_effeciency2.kpi_make_key_cache(affiliate_id, offer_id, period_date);
      if (key_cache in this.kpi_cache) {
        return this.kpi_cache[key_cache];
      }
      var key = engine_call_effeciency2.kpi_make_key(affiliate_id, offer_id);
      r = this.find_kpi_by_list(this.kpi_by_aff_offer, key, period_date);
      if (r != null) {
        this.kpi_cache[key_cache] = r;
        return r;
      }
    } 
    
    var key_cache = engine_call_effeciency2.kpi_make_key_cache(null, offer_id, period_date);

    if (key_cache in this.kpi_cache) {
      return this.kpi_cache[key_cache];
    }


    var key = engine_call_effeciency2.kpi_make_key(null, offer_id);
    r = this.find_kpi_by_list(this.kpi_by_offer, key, period_date);
    
    if (r != null) {
      this.kpi_cache[key_cache] = r;
      return r;
    }

    return null;
  }

  this.find_kpi_operator_eff = function(affiliate_id, offer_id, period_date) {

    var r = this.find_kpi(affiliate_id, offer_id, period_date);

    if (r == null)
      return null;

    if ((r.operator_efficiency == null || r.operator_efficiency < engine_call_effeciency2.min_eff) && (r.affiliate_id == affiliate_id)) {
      return this.find_kpi(null, offer_id, period_date)
    } else {
      return r;
    }

  }

  this.print = function() {
    var str = "";
    str += "AFF OFFER\n"
    for (var k in this.kpi_by_aff_offer) {
      var p = this.kpi_by_aff_offer[k];
      str += "K: " + k +"\n";
      for (var k1 in p) {
        str += "\t" + p[k1].print() + "\n";
      }
    }

    str += "OFFER\n"
    for (var k in this.kpi_by_offer) {
      var p = this.kpi_by_offer[k];
      str += "K: " + k +"\n";
      for (var k1 in p) {
        str += "\t" + p[k1].print() + "\n";
      }
    }

    return str;
  }
}

engine_call_effeciency2.stat = function() {

  this.calls_group = {};
  this.leads = {};
  this.calls_group_effective_count = 0;
  this.calls_group_with_calculation = 0;
  this.calls_group_without_calculation = 0;
  this.leads_effective_count = 0;
  this.leads_with_calculation = 0;
  this.leads_without_calculation = 0;
  this.effective_rate = 0;

  this.expecting_approved_leads = 0.0;
  this.expecting_effective_rate = 0.0;
  this.effective_percent = 0.0;
  this.kpi_calculation_errors = "";

  this.call_effeciency_second = 60;

  this.finalyzed = false;

  /** name - for debug
   * 
   */
  this.name = "";
  

  this.push_call = function(call) {
    var c = new engine_call_effeciency2.call(call);
    var key = c.make_key();
    if (!(key in this.calls_group))
      this.calls_group[key] = new engine_call_effeciency2.call_group(key, c, this.call_effeciency_second);
    this.calls_group[key].push_call(c);

  }

  this.push_lead = function(lead) {
    var l = new engine_call_effeciency2.lead(lead);
    if (l.crm_lead_id in this.leads)
      throw "Lead duplicate id: " + this.crm_lead_id;
    this.leads[l.crm_lead_id] = l;
  }

  this.get_effective_calls = function() {
    var r = Array();
    for (var k in this.calls_group) {
      if (this.calls_group[k].is_effective)
        r.push(this.calls_group[k].call_effective_first.crm_id)
    }
    return r;
  }

  this.get_effective_calls_ids = function() {
    var c = this.get_effective_calls();
    var r = "";
    for (var k in c) {
      r += c[k] + "\n"
    }
    return r;
  }

  this.finalyze = function(kpi_list) {
    if (this.finalyzed)
      throw "Effective calls already finalyzed";

    
    this.finalyzed = true;

    for (var k in this.calls_group) {
      this.calls_group[k].finalyze();


      if (this.calls_group[k].is_effective) {
        // Logger.log("EFF CALL ID: " + this.calls_group[k].key)

        if (this.calls_group[k].offer_id == 0) {
          this.calls_group_without_calculation++
          continue;
        }

        this.calls_group_with_calculation++;
        var kpi = kpi_list.find_kpi_operator_eff(this.calls_group[k].affiliate_id, this.calls_group[k].offer_id, this.calls_group[k].calldate_str);

        if (kpi == null) {
          this.expecting_approved_leads = null
          this.kpi_calculation_errors += "Can't find KPI for offer: " + this.calls_group[k].offer_id + 
            " affiliate_id: " + this.calls_group[k].affiliate_id + "\n";
        } else if (kpi.operator_efficiency < engine_call_effeciency2.min_eff) {
          this.expecting_approved_leads = null
          this.kpi_calculation_errors += "Wrong KPI for offer: " + this.calls_group[k].offer_id + 
            " affiliate_id: " + this.calls_group[k].affiliate_id + " effeciency: " + kpi.operator_efficiency + " (< " + engine_call_effeciency2.min_eff + ")\n";
        } else if (this.expecting_approved_leads != null) {
          this.expecting_approved_leads += 1 / kpi.operator_efficiency 
        }
      }
    }

    for (var k in this.leads) {
      this.leads[k].finalyze();

      if (this.leads[k].is_salary_pay) {
        if (this.leads[k].offer_id == 0) {
          this.leads_without_calculation++;
          continue
        }

        this.leads_with_calculation++;
      }
    }

    if (this.calls_group_with_calculation && this.leads_with_calculation)
      this.effective_rate = this.calls_group_with_calculation / this.leads_with_calculation
    
    if (this.expecting_approved_leads != null) {
      this.effective_percent = safe_div(this.leads_with_calculation, this.expecting_approved_leads) * 100
      this.expecting_effective_rate = safe_div(this.calls_group_with_calculation, this.expecting_approved_leads)
    } else {
      this.effective_percent = null;      
    }

    this.calls_group_effective_count = this.calls_group_without_calculation + this.calls_group_with_calculation;
    this.leads_effective_count = this.leads_with_calculation + this.leads_without_calculation;
  }

  this.print_kpi = function() {
    var str = "";
    for (var k in this.kpi) {
      var kpi = this.kpi[k]
      str += "Offer ID: " + k + " period: " + kpi.period_date + " eff: " + kpi.operator_efficiency + "\n"
    }

    return str;
  }

}

engine_call_effeciency2.get_kpi_query = function() {
  var q = "SELECT\n"+
  "offer_plan.id as call_eff_kpi_id,\n"+
  "offer_plan.period_date as call_eff_period_date,\n"+
  "offer_plan.offer_id as call_eff_offer_id,\n"+
  "aff.external_id as call_eff_affiliate_id,\n"+
  "LEFT(" + dbq.time_add("HOUR", 3, "offer_plan.updated_at") + ", 10) as call_eff_plan_update_date,\n"+

  "offer_plan.confirmation_price call_eff_confirmation_price,\n"+
  "offer_plan.buyout_price call_eff_buyout_price,\n"+

  "offer_plan.operator_efficiency as call_eff_operator_efficiency,\n"+
  
  "LEFT(" + dbq.time_add("HOUR", 3, "offer_plan.operator_efficiency_updated_at") + ", 10) as call_eff_operator_efficiency_update_date,\n"+

  "offer_plan.planned_approve_from call_eff_planned_approve,\n" + 
  
  "LEFT(" + dbq.time_add("HOUR", 3, "offer_plan.planned_approve_update_at") + ", 10) as call_eff_approve_update_date,\n"+

  "offer_plan.planned_buyout_from call_eff_planned_buyout,\n" + 
  
  "LEFT(" + dbq.time_add("HOUR", 3, "offer_plan.planned_buyout_update_at") + ", 10) as call_eff_buyout_update_date,\n"+

  "offer_plan.confirmation_price call_eff_confirmation_price,\n" + 
  
  "LEFT(" + dbq.time_add("HOUR", 3, "offer_plan.confirmation_price_updated_at") + ", 10) as call_eff_confirmation_price_update_date,\n"+

  "offer_plan.buyout_price call_eff_buyout_price,\n" + 
  
  "LEFT(" + dbq.time_add("HOUR", 3, "offer_plan.buyout_price_updated_at") + ", 10) as call_eff_buyout_price_update_date\n"+


  "FROM partners_tlofferplanneddataperiod AS offer_plan\n"+
  "LEFT JOIN partners_affiliate aff ON aff.id = offer_plan.affiliate_id\n"+
  "ORDER BY period_date ASC";
  return q;
}

engine_call_effeciency2.make_kpi_list = function(stmt) {
  var q = engine_call_effeciency2.get_kpi_query();
  Logger.log("Q: " + q);
  var r = stmt.executeQuery(q);
  var kpi_list = new engine_call_effeciency2.kpi_list();
  while (r.next())
    kpi_list.push_kpi(r);
  return kpi_list;
}

function engine_call_effeciency2_test_query_leads() {
  var q = ""+
  "SELECT\n"+
  "crm_leads_crmlead.id call_eff_crm_lead_id,\n"+
  
  "LEFT(" + dbq.time_add("HOUR", 3, "lv.approved_at") + ", 19) AS call_eff_approved_at,\n"+
  "LEFT(" + dbq.time_add("HOUR", 3, "lv.canceled_at") + ", 19) AS call_eff_canceled_at,\n"+  
  "uu.id as call_eff_operator_id,\n"+
  "lv_status.status_verbose as call_eff_status_verbose\n"+
  "FROM partners_lvlead lv\n"+
  "LEFT JOIN crm_leads_crmlead ON crm_leads_crmlead.lvlead_id = lv.id\n"+
  "LEFT JOIN partners_lvoperator lv_op ON lv_op.id = lv.operator_id\n"+
  "LEFT JOIN partners_userbasedonlvoperator pu ON pu.operator_id = lv.operator_id \n"+
  "LEFT JOIN users_user uu ON uu.id = pu.user_id \n"+
  "LEFT JOIN partners_lvleadstatuses AS lv_status ON lv.leadvertex_status_id = lv_status.id \n"+  
  "WHERE 1=1\n"+
  "AND " + dbq.time_add("HOUR", 3, "lv.approved_at") + " >= '2023-12-14 00:00:00'\n"+
  "AND " + dbq.time_add("HOUR", 3, "lv.approved_at") + " < '2023-12-15 00:00:00'\n";

  return q;

}

function engine_call_effeciency2_test_query_calls() {

  var q = ""+
    "SELECT\n"+
    "partners_atscallevent.id as call_eff_id,\n"+    
    "crm_call_calldata.id as call_eff_crm_id,\n"+ 
    "po.id as call_eff_offer_id,\n"+     
    "partners_atscallevent.uniqueid as call_eff_uniqueid,\n"+
    
    "LEFT(" + dbq.time_add("HOUR", 3, "partners_atscallevent.calldate") + ", 10) AS call_eff_calldate,\n"+
    "crm_call_calldata.crm_lead_id as call_eff_crm_lead_id,\n"+    
    "uu.id as call_eff_operator_id,\n"+
    "partners_atscallevent.billsec as call_eff_billsec,\n"+
    "crm_call_calldata.oktell_duration as call_eff_billsec_exact,\n"+
    "crm_call_calldata.oktell_anti_robot as call_eff_robo_detected,\n"+
    "pt.webmaster_id as call_eff_affiliate_id\n"+
    "FROM partners_atscallevent\n"+
    "LEFT JOIN crm_call_calldata ON crm_call_calldata.id = partners_atscallevent.assigned_call_data_id\n"+
    "LEFT JOIN partners_lvlead ON partners_atscallevent.lvlead_id = partners_lvlead.id\n"+
    "LEFT JOIN crm_leads_crmlead ON crm_leads_crmlead.lvlead_id = partners_lvlead.id\n"+    
    "LEFT JOIN partners_lvoperator lv_op ON lv_op.id = partners_atscallevent.lvoperator_id\n"+
    "LEFT JOIN partners_userbasedonlvoperator pu ON pu.operator_id = partners_atscallevent.lvoperator_id\n"+
    "LEFT JOIN users_user uu ON uu.id = pu.user_id\n"+
    "LEFT JOIN users_department ud ON ud.id = uu.department_id\n"+    
    "LEFT JOIN partners_tllead pt ON partners_lvlead.tl_id = pt.external_id \n " +         
    "LEFT JOIN partners_offer po ON pt.offer_id = po.id \n " +    
    "WHERE 1=1\n"+
    "AND partners_atscallevent.billsec >= 1\n"+
    "AND ((ud.name LIKE N'%_НП_%'))\n"+
    "AND " + dbq.time_add("HOUR", 3, "partners_atscallevent.calldate") + " >= '2023-12-14 00:00:00'\n"+
    "AND " + dbq.time_add("HOUR", 3, "partners_atscallevent.calldate") + " < '2023-12-15 00:00:00'\n";


    return q;
}




function engine_call_effeciency2_test() {

  var stat = new engine_call_effeciency2.stat();
  var conn = conn_to_db()
  var stmt = conn.createStatement()  

  var kpi_list = engine_call_effeciency2.make_kpi_list(stmt);


  q = engine_call_effeciency2_test_query_calls();
  Logger.log("Q: " + q);
  var r = stmt.executeQuery(q);
  while (r.next())
    stat.push_call(r);
  q = engine_call_effeciency2_test_query_leads();
  Logger.log("Q: " + q);
  var r = stmt.executeQuery(q);
  while (r.next())
    stat.push_lead(r);
  

  stat.finalyze(kpi_list);

  //Logger.log("KPI -->");
  //Logger.log(kpi_list.print());

  Logger.log("Effective calls group: " + stat.calls_group_effective_count)

  if (stat.calls_group_effective_count != 1252)
    throw "Wrong effective calls count: " + stat.calls_group_effective_count  + " expect 1252";
  Logger.log("Effective leads:" + stat.leads_effective_count)
  if (stat.leads_effective_count != 176)
    throw "Wrong effective calls count: " + stat.leads_effective_count  + " expect 176";  
  Logger.log("Effective rate: " + stat.effective_rate );
  Logger.log("Effective percent: " + print_float(stat.effective_percent))
  Logger.log("Effective percent errors: " + stat.kpi_calculation_errors)

// RUN find kpi: 265 msk: 2023-10-05
  var r = kpi_list.find_kpi(null, 265, now_msk_date_str);
//  Logger.log(r);

}


function engine_call_effeciency2_test2() {

  var conn = conn_to_db()
  var stmt = conn.createStatement()  

  q = "SELECT NULL as a;"

  r = stmt.executeQuery(q);
  r.next();
  Logger.log(r.getInt('a'));  
  Logger.log(r.getString('a'));  

}
